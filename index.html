<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>静清ARサンプル（完成版）</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        #controls button {
            margin: 4px;
            padding: 6px 10px;
        }
    </style>
</head>
<body>

<a-scene embedded arjs="debugUIEnabled:false;">
    <a-assets>
        <a-asset-item id="obj" src="tinker.obj"></a-asset-item>
        <a-asset-item id="mtl" src="obj.mtl"></a-asset-item>
    </a-assets>

    <a-marker type="pattern" url="sei.patt">
        <a-obj-model 
            id="model"
            src="#obj"
            mtl="#mtl"
            scale="0.1 0.1 0.1"
            rotation="90 0 90"
            position="0 0 0">
        </a-obj-model>
    </a-marker>

    <a-entity camera></a-entity>
</a-scene>

<div id="controls">
    <button id="rotateX">X回転</button>
    <button id="rotateY">Y回転</button>
    <button id="rotateZ">Z回転</button>
    <button id="scaleUp">拡大</button>
    <button id="scaleDown">縮小</button>

    <button id="moveXPlus">X＋</button>
    <button id="moveXMinus">X－</button>
    <button id="moveYPlus">Y＋</button>
    <button id="moveYMinus">Y－</button>
    <button id="moveZPlus">Z＋</button>
    <button id="moveZMinus">Z－</button>

    <button id="capture">撮影</button>
</div>

<script>
    const model = document.getElementById('model');

    /* ===== 回転 ===== */
    let rotatingAxis = null; // 'x', 'y', 'z'
    const rotationSpeed = 1;

    function rotateModel() {
        if (rotatingAxis) {
            const rot = model.getAttribute('rotation');
            rot[rotatingAxis] += rotationSpeed;
            model.setAttribute('rotation', rot);
        }
        requestAnimationFrame(rotateModel);
    }

    document.getElementById('rotateX').addEventListener('click', () => {
        rotatingAxis = rotatingAxis === 'x' ? null : 'x';
    });

    document.getElementById('rotateY').addEventListener('click', () => {
        rotatingAxis = rotatingAxis === 'y' ? null : 'y';
    });

    document.getElementById('rotateZ').addEventListener('click', () => {
        rotatingAxis = rotatingAxis === 'z' ? null : 'z';
    });

    rotateModel();

    /* ===== 拡大・縮小 ===== */
    document.getElementById('scaleUp').addEventListener('click', () => {
        const scale = model.getAttribute('scale');
        scale.x += 0.01;
        scale.y += 0.01;
        scale.z += 0.01;
        model.setAttribute('scale', scale);
    });

    document.getElementById('scaleDown').addEventListener('click', () => {
        const scale = model.getAttribute('scale');
        scale.x = Math.max(0.01, scale.x - 0.01);
        scale.y = Math.max(0.01, scale.y - 0.01);
        scale.z = Math.max(0.01, scale.z - 0.01);
        model.setAttribute('scale', scale);
    });

    /* ===== 移動 ===== */
    const moveStep = 0.05;

    document.getElementById('moveXPlus').addEventListener('click', () => {
        const pos = model.getAttribute('position');
        pos.x += moveStep;
        model.setAttribute('position', pos);
    });

    document.getElementById('moveXMinus').addEventListener('click', () => {
        const pos = model.getAttribute('position');
        pos.x -= moveStep;
        model.setAttribute('position', pos);
    });

    document.getElementById('moveYPlus').addEventListener('click', () => {
        const pos = model.getAttribute('position');
        pos.y += moveStep;
        model.setAttribute('position', pos);
    });

    document.getElementById('moveYMinus').addEventListener('click', () => {
        const pos = model.getAttribute('position');
        pos.y -= moveStep;
        model.setAttribute('position', pos);
    });

    document.getElementById('moveZPlus').addEventListener('click', () => {
        const pos = model.getAttribute('position');
        pos.z += moveStep;
        model.setAttribute('position', pos);
    });

    document.getElementById('moveZMinus').addEventListener('click', () => {
        const pos = model.getAttribute('position');
        pos.z -= moveStep;
        model.setAttribute('position', pos);
    });

    /* ===== 撮影 ===== */
    document.getElementById('capture').addEventListener('click', () => {
        const sceneEl = document.querySelector('a-scene');
        const renderer = sceneEl.renderer;
        const video = document.querySelector('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = renderer.domElement.width;
        canvas.height = renderer.domElement.height;

        if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }

        renderer.render(sceneEl.object3D, sceneEl.camera);
        ctx.drawImage(renderer.domElement, 0, 0);

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = 'screenshot.png';
        link.click();
    });
</script>

</body>
</html>
